#define FILTERS_C

#include <math.h>
#include "nespal.h"
#include "filters.h"
#include "global.h"

unsigned rgb_palette[64];
unsigned grayscale_palette[64];

void build_color_maps (void)    
{
    for (int i=0; i<64; i++) {
        rgb_palette[i] = (nes_palette[i*3] << 16) | (nes_palette[i*3+1] << 8) | nes_palette[i*3+2];
        grayscale_palette[i] = (nes_palette[i*3] + nes_palette[i*3+1] + nes_palette[i*3+2]) / 3;        
    }
}

static inline unsigned convert_pixel (byte color, byte emphasis)
{
    emphasis &= 0xE1;
    if (!emphasis) return rgb_palette[color & 63];
    else {
        if (emphasis & 1) color &= 0x30;
        unsigned px = rgb_palette[color & 63];
        byte r = px >> 16, g = (px >> 8) & 0xFF, b = px & 0xFF;
        // This is almost certainly wrong.
        if (emphasis & 0x20) { g = g*3/4; b = b*3/4; }
        if (emphasis & 0x40) { r = r*3/4; b = b*3/4; }
        if (emphasis & 0x80) { r = r*3/4; g = g*3/4; }        
        return (r << 16) | (g << 8) | b;
    }
}

void no_filter_emitter (unsigned y, byte *colors, byte *emphasis)
{
    Uint32 *dest = (Uint32 *)(((byte *)window_surface->pixels) + y * window_surface->pitch);
    for (int x = 0; x < 256; x++) *dest++ = convert_pixel(colors[x], emphasis[x]);
}

void no_filter (void)
{
    vid_width = 256;
    vid_height = 240;
    vid_bpp = 32;
    filter_output_line = no_filter_emitter;
    build_color_maps();
}

void filter_finish_nop (void)
{
}

void rescale_2x_emitter (unsigned y, byte *colors, byte *emphasis)
{
    Uint32 *dest0 = (Uint32 *) (((byte *)window_surface->pixels) + (y*2) * window_surface->pitch);
    Uint32 *dest1 = (Uint32 *) (((byte *)window_surface->pixels) + (y*2+1) * window_surface->pitch);
    for (int x = 0; x < 256; x++) {
        Uint32 px = convert_pixel(colors[x], emphasis[x]);
        *dest0++ = px; 
        *dest0++ = px;
        *dest1++ = px; 
        *dest1++ = px;
    }
}

void rescale_2x (void)
{
    vid_width = 512;
    vid_height = 480;
    vid_bpp = 32;
    filter_output_line = rescale_2x_emitter;
    build_color_maps();
}

/* Scanline filter with alternating fields */

void scanline_emitter (unsigned y, byte *colors, byte *emphasis)
{
    int field = (nes.time & 1);
    Uint32 *dest0 = (Uint32 *) (((byte *)window_surface->pixels) + (y*2+field) * window_surface->pitch);
    Uint32 *dest1 = (Uint32 *) (((byte *)window_surface->pixels) + (y*2+(field^1)) * window_surface->pitch);
    for (int x = 0; x < 256; x++) {
        Uint32 px = convert_pixel(colors[x], emphasis[x]);
        *dest0++ = px; 
        *dest0++ = px;

        Uint32 nx = dest1[0];
        byte r = nx >> 16, g = (nx >> 8) & 0xFF, b = nx & 0xFF;
        r = r*3/4; 
        g = g*3/4; 
        b = b*3/4;
        nx = (r << 16) | (g << 8) | b;
        dest1[1] = dest1[0] = nx;
        dest1 += 2;
    }
}

void scanline_filter (void)
{
    rescale_2x();
    filter_output_line = scanline_emitter;
}

/* NTSC filter */

static inline Uint32 rgbi (byte r, byte g, byte b)
{
    return (r << 16) | (g << 8) | b;
}

static inline Uint32 rgbf (float r, float g, float b)
{
    r *= 255.0;
    if (r < 0) r = 0.0;
    if (r > 255.0) r = 255.0;
    g *= 255.0;
    if (g < 0) g = 0.0;
    if (g > 255.0) g = 255.0;
    b *= 255.0;
    if (b < 0) b = 0.0;
    if (b > 255.0) b = 255.0;

    return rgbi(r,g,b);
}

static inline void yiq2rgb (float yiq[3], float rgb[3])
{
    rgb[0] = yiq[0] +  0.9563*yiq[1] +  0.6210*yiq[2];
    rgb[1] = yiq[0] + -0.2721*yiq[1] + -0.6474*yiq[2];
    rgb[2] = yiq[0] + -1.1070*yiq[1] +  1.7046*yiq[2];
}

float yiq_table[64][3];
float chroma_output[64][12];
float kern_i12[12];
float kern_q12[12];

#define K160SIZE 769
float kern_sinc_160[K160SIZE] = {-0.000000000007261629145836825, 0.0000000030924237138310454, 0.00000001303529042577693, 0.000000030749726241401656, 0.00000005711214395008524, 0.00000009294226762691291, 0.00000013899854703151382, 0.00000019597371227917943, 0.00000026449048080843085, 0.0000003450974285770416, 0.0000004382650373127325, 0.000000544381929523405, 0.0000006637513028363755, 0.0000007965875750841705, 0.0000009430132513843642, 0.0000011030560242747707, 0.0000012766461177585103, 0.0000014636138858868936, 0.0000016636876762617025, 0.0000018764919685678679, 0.0000021015457979567747, 0.0000023382614727827115, 0.0000025859435958545524, 0.0000028437883979970217, 0.000003110883392322205, 0.0000033862073571896526, 0.0000036686306553836986, 0.000003956915896556205, 0.000004249718949473676, 0.000004545590310067237, 0.0000048429768307122624, 0.000005140223815561383, 0.000005435577486118776, 0.000005727187820577199, 0.000006013111769737638, 0.000006291316851600629, 0.0000065596851259521466, 0.0000068160175494703714, 0.000007058038711051434, 0.000007283401946190619, 0.000007489694828366712, 0.000007674445034454643, 0.000007835126580243209, 0.000007969166421157224, 0.00000807395141227854, 0.000008146835620732998, 0.000008185147982456669, 0.000008186200294280799, 0.000008147295531181097, 0.000008065736477425326, 0.000007938834659225164, 0.000007763919565359145, 0.000007538348141081892, 0.000007259514539476985, 0.0000069248601132471956, 0.000006531883628771062, 0.000006078151683090762, 0.0000055613093033377595, 0.000004979090706951408, 0.000004329330199907344, 0.0000036099731890481015, 0.0000028190872835044534, 0.0000019548734591152567, 0.0000010156772586978746, -0.000000000000000000013152446309451748, -0.0000010934900378253086, -0.0000022659464793270525, -0.0000035183338004573568, -0.000004851416390733243, -0.000006265747762531406, -0.000007761659940936755, -0.000009339253068251853, -0.000010998385257899329, -0.00001273866273300114, -0.0000145594302854006, -0.000016459762091295963, -0.00001843845291997776, -0.00002049400977239928, -0.000022624643986458102, -0.000024828263845925665, -0.00002710246772992086, -0.000029444537839688176, -0.000031851434539200274, -0.00003431979134576271, -0.00003684591060634508, -0.00003942575989480444, -0.000042054969164491615, -0.0000447288286899454, -0.00004744228783047806, -0.000050189954647435854, -0.000052966096405781105, -0.00005576464098938862, -0.00005857917925807382, -0.00006140296837287721, -0.00006422893611451743, -0.00006704968621819605, -0.00006985750474608888, -0.00007264436751689659, -0.00007540194860974886, -0.00007812162995757008, -0.00008079451204271183, -0.00008341142570525735, -0.00008596294507188996, -0.0000884394016106121, -0.00009083089931389753, -0.00009312733101006195, -0.00009531839579975903, -0.00009739361761154224, -0.00009934236486739733, -0.00010115387124603938, -0.00010281725752859785, -0.00010432155450808331, -0.00010565572694075021, -0.00010680869851414919, -0.00010776937780330515, -0.00010852668518307301, -0.00010906958066132131, -0.00010938709259417952, -0.00010946834724116891, -0.00010930259911463272, -0.00010887926207448268, -0.00010818794111592136, -0.00010721846479446144, -0.00010596091822928321, -0.00010440567662273618, -0.00010254343923062562, -0.00010036526371483588, -0.0000978626008068277, -0.00009502732920764394, -0.00009185179064724055, -0.00008832882502327439, -0.00008445180553690661, -0.00008021467374074684, -0.0000756119744117777, -0.00007063889015995628, -0.00006529127568122804, -0.00005956569156187627, -0.00005345943753952237, -0.000046970585124660407, -0.00004009800948537961, -0.000032841420496909095, -0.00002520139285680706, -0.000017179395166039315, -0.00000877781787582273, 0.00000000000000000008386916293129118, 0.000009149745507175847, 0.00001866610780759681, 0.000028542755769330838, 0.00003877231718838233, 0.00004934635973930429, 0.00006025537375038454, 0.00007148875689745368, 0.00008303480090844057, 0.00009488068036858147, 0.00010701244371371984, 0.00011941500649638169, 0.00013207214700629302, 0.00014496650432371905, 0.0001580795788804385, 0.00017139173559935946, 0.0001848822096796856, 0.0001985291150902066, 0.00021230945582869108, 0.00022619914000051843, 0.00024017299676460304, 0.00025420479618934726, 0.00026826727205581905, 0.00028233214763958084, 0.00029637016449664245, 0.00031035111427282286, 0.00032424387354946767, 0.00033801644173192037, 0.00035163598198045826, 0.0003650688651765471, 0.0003782807169102775, 0.0003912364674677336, 0.0004039004047898172, 0.0004162362303667197, 0.00042820711802483963, 0.00043977577555546745, 0.0004509045091270388, 0.00046155529041521384, 0.0004716898263774653, 0.00048126963159130377, 0.0004902561030677183, 0.0004986105974439094, 0.0005062945104519462, 0.0005132693585526024, 0.0005194968626163486, 0.0005249390335263194, 0.0005295582595710276, 0.0005333173954877273, 0.0005361798530106028, 0.0005381096927714424, 0.0005390717173941299, 0.0005390315656181965, 0.0005379558072808215, 0.0005358120389810869, 0.0005325689802449672, 0.0005281965700045334, 0.0005226660632001466, 0.0005159501273100348, 0.0005080229386076304, 0.000498860277943375, 0.0004884396258444088, 0.00047674025672265834, 0.00046374333197934383, 0.00044943199179183315, 0.00043379144536713455, 0.0004168090594450819, 0.00039847444483351584, 0.0003787795407574475, 0.0003577186968043499, 0.000335288752248363, 0.0003114891125372969, 0.00028632182272792834, 0.00025979163765717966, 0.00023190608863933772, 0.0002026755464825676, 0.00017211328062154954, 0.00014023551416713546, 0.00010706147467851664, 0.00007261344046843128, 0.00003691678225752201, -0.0000000000000000002339935675455113, -0.0000381052452907284, -0.00007736410488078213, -0.00011773852097574784, -0.00015918721085078123, -0.00020166565659143458, -0.00024512610057699836, -0.00028951754682890127, -0.00033478576833708134, -0.0003808733204672477, -0.0004277195605415153, -0.0004752606736741671, -0.0005234297049331875, -0.0005721565978867834, -0.0006213682395824091, -0.0006709885119937918, -0.0007209383499591896, -0.0007711358056216428, -0.0008214961193692491, -0.0008719317972606037, -0.000922352694907507, -0.0009726661077738133, -0.0010227768678360404, -0.0010725874465379384, -0.001121998063957788, -0.0011709068040937475, -0.0012192097361590896, -0.0012668010417657407, -0.0013135731478611658, -0.0013594168652703547, -0.0014042215326815141, -0.001447875165901034, -0.0014902646121904626, -0.0015312757094856197, -0.0015707934502855376, -0.0016087021499868255, -0.0016448856194272092, -0.0016792273413904733, -0.00171161065081389, -0.0017419189184284317, -0.001770035737551685, -0.0017958451137434425, -0.001819231657024476, -0.0018400807763499765, -0.0018582788760206739, -0.0018737135537066764, -0.0018862737997516672, -0.0018958501974182754, -0.0019023351237291914, -0.0019056229505529938, -0.0019056102455786638, -0.0019021959728184445, -0.001895281692275002, -0.0018847717584059528, -0.001870573517016409, -0.00185259750020873, -0.001830757619017758, -0.0018049713533596634, -0.0017751599389231743, -0.0017412485506332785, -0.0017031664823195514, -0.0016608473222241682, -0.0016142291239881448, -0.00156325457275877, -0.001507871146066212, -0.001448031269123147, -0.0013836924642077761, -0.0013148174937979227, -0.0012413744971318987, -0.001163337119880574, -0.0010806846366244777, -0.0009934020658399175, -0.0009014802771088767, -0.0008049160902788957, -0.0007037123663112253, -0.0005978780895682671, -0.0004874284413046142, -0.0003723848641398793, -0.00025277511730594225, -0.0001286333224762159, 0.00000000000000000040810420656599014, 0.0001330779046190788, 0.0002705470041451454, 0.0004123474630604884, 0.0005584130011549042, 0.000708670907347062, 0.0008630420638131169, 0.001021440980479637, 0.001183775839919513, 0.001349948552670931, 0.0015198548229806753, 0.001693384224954111, 0.0018704202890751345, 0.0020508405990402948, 0.002234516898832146, 0.0024213152099377697, 0.0026110959585993005, 0.002803714112964324, 0.0029990193299851494, 0.003196856111897222, 0.0033970639720884745, 0.0035994776101531184, 0.0038039270959054515, 0.004010238062111512, 0.004218231905679172, 0.004427725997030283, 0.004638533897362042, 0.004850465583488665, 0.005063327679938962, 0.005276923697970334, 0.005491054281145382, 0.005705517457103336, 0.005920108895145368, 0.006134622169240265, 0.006348849026045071, 0.006562579657524041, 0.0067756029777389535, 0.006987706903373987, 0.007198678637549581, 0.0074083049564715436, 0.0076163724984544086, 0.007822668054851593, 0.008026978862419338, 0.00822909289663672, 0.008428799165500128, 0.00862588800330777, 0.008820151363947641, 0.009011383113201316, 0.009199379319575738, 0.009383938543175856, 0.009564862122132608, 0.009741954456103302, 0.009915023286364963, 0.010083879972025494, 0.010248339761882944, 0.010408222061469226, 0.010563350694821819, 0.010713554160534879, 0.010858665881650081, 0.010998524448957095, 0.011132973857284227, 0.011261863734370966, 0.01138504956192637, 0.011502392888490054, 0.011613761533726235, 0.011719029783795557, 0.011818078577464522, 0.011910795682628067, 0.011997075862937119, 0.012076821034239967, 0.012149940410563699, 0.012216350639380228, 0.01227597592591966, 0.012328748146313104, 0.01237460694936624, 0.012413499846784927, 0.0124453822916943, 0.01247021774531322, 0.012487977731666926, 0.012498641880241437, 0.012502197956504825, 0.012498641880241437, 0.012487977731666926, 0.012470217745313221, 0.0124453822916943, 0.012413499846784927, 0.01237460694936624, 0.012328748146313104, 0.012275975925919662, 0.012216350639380228, 0.012149940410563699, 0.012076821034239968, 0.01199707586293712, 0.011910795682628067, 0.011818078577464522, 0.011719029783795559, 0.011613761533726237, 0.011502392888490054, 0.011385049561926371, 0.011261863734370966, 0.011132973857284227, 0.010998524448957096, 0.010858665881650083, 0.010713554160534879, 0.010563350694821819, 0.010408222061469226, 0.010248339761882944, 0.010083879972025494, 0.009915023286364963, 0.009741954456103303, 0.009564862122132608, 0.009383938543175856, 0.009199379319575738, 0.009011383113201316, 0.008820151363947643, 0.00862588800330777, 0.00842879916550013, 0.00822909289663672, 0.00802697886241934, 0.007822668054851595, 0.007616372498454409, 0.007408304956471544, 0.007198678637549583, 0.006987706903373988, 0.006775602977738956, 0.006562579657524042, 0.006348849026045071, 0.006134622169240265, 0.005920108895145368, 0.005705517457103338, 0.005491054281145384, 0.0052769236979703345, 0.005063327679938962, 0.004850465583488665, 0.0046385338973620426, 0.004427725997030285, 0.0042182319056791725, 0.004010238062111513, 0.0038039270959054523, 0.0035994776101531192, 0.0033970639720884745, 0.0031968561118972238, 0.0029990193299851502, 0.0028037141129643255, 0.002611095958599301, 0.00242131520993777, 0.002234516898832146, 0.0020508405990402948, 0.0018704202890751352, 0.0016933842249541111, 0.001519854822980676, 0.0013499485526709315, 0.0011837758399195135, 0.001021440980479637, 0.0008630420638131173, 0.0007086709073470622, 0.0005584130011549043, 0.0004123474630604886, 0.0002705470041451454, 0.0001330779046190788, 0.0000000000000000004081042065659902, -0.00012863332247621602, -0.0002527751173059423, -0.0003723848641398794, -0.00048742844130461436, -0.0005978780895682673, -0.0007037123663112253, -0.0008049160902788957, -0.0009014802771088772, -0.0009934020658399177, -0.0010806846366244781, -0.0011633371198805744, -0.0012413744971318992, -0.001314817493797923, -0.0013836924642077768, -0.0014480312691231476, -0.0015078711460662125, -0.0015632545727587706, -0.001614229123988145, -0.0016608473222241682, -0.0017031664823195514, -0.0017412485506332791, -0.0017751599389231754, -0.0018049713533596645, -0.001830757619017759, -0.0018525975002087309, -0.0018705735170164094, -0.001884771758405953, -0.0018952816922750033, -0.0019021959728184445, -0.0019056102455786653, -0.0019056229505529947, -0.0019023351237291918, -0.0018958501974182757, -0.001886273799751669, -0.0018737135537066775, -0.0018582788760206756, -0.001840080776349978, -0.0018192316570244769, -0.0017958451137434432, -0.0017700357375516852, -0.0017419189184284326, -0.0017116106508138903, -0.001679227341390475, -0.0016448856194272107, -0.0016087021499868266, -0.001570793450285538, -0.0015312757094856212, -0.0014902646121904637, -0.0014478751659010344, -0.0014042215326815156, -0.0013594168652703556, -0.001313573147861166, -0.001266801041765741, -0.0012192097361590907, -0.0011709068040937482, -0.0011219980639577893, -0.0010725874465379395, -0.0010227768678360409, -0.0009726661077738133, -0.000922352694907507, -0.0008719317972606043, -0.0008214961193692493, -0.0007711358056216437, -0.0007209383499591902, -0.0006709885119937922, -0.0006213682395824092, -0.0005721565978867839, -0.0005234297049331878, -0.0004752606736741676, -0.00042771956054151567, -0.0003808733204672479, -0.00033478576833708145, -0.00028951754682890127, -0.0002451261005769986, -0.00020166565659143472, -0.00015918721085078147, -0.00011773852097574796, -0.00007736410488078219, -0.0000381052452907284, -0.0000000000000000002339935675455113, 0.000036916782257522034, 0.0000726134404684313, 0.00010706147467851676, 0.00014023551416713555, 0.0001721132806215496, 0.00020267554648256762, 0.000231906088639338, 0.00025979163765717987, 0.0002863218227279288, 0.00031148911253729727, 0.00033528875224836326, 0.00035771869680435, 0.00037877954075744754, 0.00039847444483351617, 0.000416809059445082, 0.0004337914453671351, 0.0004494319917918337, 0.0004637433319793442, 0.0004767402567226586, 0.0004884396258444094, 0.0004988602779433755, 0.0005080229386076306, 0.0005159501273100356, 0.000522666063200147, 0.0005281965700045336, 0.0005325689802449672, 0.0005358120389810875, 0.0005379558072808221, 0.0005390315656181974, 0.0005390717173941307, 0.000538109692771443, 0.000536179853010603, 0.0005333173954877273, 0.0005295582595710282, 0.0005249390335263195, 0.0005194968626163494, 0.000513269358552603, 0.0005062945104519468, 0.0004986105974439096, 0.0004902561030677191, 0.0004812696315913042, 0.0004716898263774661, 0.00046155529041521444, 0.00045090450912703927, 0.0004397757755554677, 0.00042820711802483963, 0.0004162362303667201, 0.00040390040478981766, 0.00039123646746773444, 0.00037828071691027804, 0.00036506886517654756, 0.00035163598198045836, 0.00033801644173192086, 0.00032424387354946805, 0.0003103511142728231, 0.0002963701644966429, 0.0002823321476395812, 0.0002682672720558192, 0.00025420479618934737, 0.00024017299676460345, 0.0002261991400005187, 0.00021230945582869151, 0.00019852911509020692, 0.00018488220967968581, 0.00017139173559935954, 0.0001580795788804385, 0.00014496650432371924, 0.00013207214700629313, 0.0001194150064963819, 0.00010701244371372, 0.00009488068036858156, 0.00008303480090844059, 0.00007148875689745382, 0.000060255373750384616, 0.00004934635973930431, 0.000038772317188382406, 0.00002854275576933088, 0.000018666107807596828, 0.000009149745507175852, 0.00000000000000000008386916293129131, -0.000008777817875822739, -0.000017179395166039356, -0.000025201392856807108, -0.000032841420496909136, -0.00004009800948537963, -0.000046970585124660407, -0.00005345943753952245, -0.000059565691561876304, -0.0000652912756812282, -0.00007063889015995639, -0.00007561197441177777, -0.00008021467374074687, -0.00008445180553690675, -0.00008832882502327454, -0.00009185179064724079, -0.00009502732920764412, -0.00009786260080682784, -0.00010036526371483588, -0.00010254343923062568, -0.00010440567662273638, -0.00010596091822928331, -0.00010721846479446167, -0.00010818794111592152, -0.00010887926207448287, -0.00010930259911463279, -0.00010946834724116917, -0.00010938709259417967, -0.0001090695806613216, -0.00010852668518307301, -0.00010776937780330534, -0.00010680869851414934, -0.00010565572694075046, -0.00010432155450808321, -0.00010281725752859795, -0.00010115387124603968, -0.00009934236486739755, -0.00009739361761154239, -0.00009531839579975911, -0.00009312733101006217, -0.00009083089931389745, -0.00008843940161061221, -0.00008596294507189021, -0.00008341142570525754, -0.00008079451204271193, -0.00007812162995757012, -0.00007540194860974907, -0.00007264436751689686, -0.00006985750474608897, -0.00006704968621819619, -0.00006422893611451756, -0.0000614029683728773, -0.000058579179258073855, -0.00005576464098938872, -0.00005296609640578132, -0.000050189954647435874, -0.00004744228783047818, -0.00004472882868994547, -0.000042054969164491784, -0.00003942575989480443, -0.00003684591060634513, -0.000034319791345762825, -0.0000318514345392003, -0.000029444537839688254, -0.000027102467729920918, -0.000024828263845925732, -0.000022624643986458078, -0.000020494009772399304, -0.000018438452919977837, -0.000016459762091296, -0.000014559430285400632, -0.00001273866273300116, -0.000010998385257899354, -0.000009339253068251848, -0.000007761659940936765, -0.000006265747762531431, -0.000004851416390733253, -0.0000035183338004573627, -0.0000022659464793270537, -0.0000010934900378253148, -0.00000000000000000001315244630945184, 0.000001015677258697876, 0.0000019548734591152643, 0.000002819087283504464, 0.000003609973189048109, 0.000004329330199907351, 0.000004979090706951426, 0.000005561309303337785, 0.000006078151683090775, 0.000006531883628771085, 0.000006924860113247208, 0.000007259514539476996, 0.000007538348141081895, 0.000007763919565359165, 0.000007938834659225227, 0.000008065736477425316, 0.000008147295531181118, 0.000008186200294280803, 0.000008185147982456733, 0.000008146835620733007, 0.000008073951412278573, 0.00000796916642115729, 0.000007835126580243209, 0.000007674445034454632, 0.000007489694828366722, 0.000007283401946190684, 0.000007058038711051456, 0.000006816017549470427, 0.0000065596851259521694, 0.000006291316851600663, 0.0000060131117697376495, 0.000005727187820577187, 0.0000054355774861188116, 0.0000051402238155613465, 0.000004842976830712238, 0.000004545590310067274, 0.000004249718949473689, 0.00000395691589655623, 0.0000036686306553837354, 0.0000033862073571896526, 0.0000031108833923222296, 0.0000028437883979969967, 0.0000025859435958545524, 0.000002338261472782724, 0.000002101545797956763, 0.0000018764919685678679, 0.000001663687676261726, 0.00000146361388588694, 0.0000012766461177584988, 0.0000011030560242747932, 0.0000009430132513843532, 0.0000007965875750841813, 0.0000006637513028363755, 0.0000005443819295233947, 0.00000043826503731275264, 0.0000003450974285770416, 0.0000002644904808084214, 0.00000019597371227917943, 0.00000013899854703153158, 0.00000009294226762691291, 0.00000005711214395008524, 0.000000030749726241425274, 0.00000001303529042577693, 0.0000000030924237138310454, -0.000000000007261629145836825};

#define K120SIZE 513
float kern_sinc_120[K120SIZE] = {-0.000000000014058133132289859, 0.000000012185186549259826, 0.000000046481014029837505, 0.00000009910242432006978, 0.000000165870363938515, 0.0000002422228695576846, 0.0000003232426986725041, 0.0000004036873922555991, 0.0000004780217073309537, 0.0000005404523499988581, 0.0000005849649316631095, 0.0000006053630630327623, 0.0000005953094918808488, 0.0000005483691815428935, 0.0000004580542177296339, 0.00000031787042142031465, 0.00000012136553541562386, -0.00000013782115841554202, -0.0000004659079450300238, -0.0000008689186702325313, -0.0000013526297992035242, -0.000001922516727482701, -0.0000025836995440498144, -0.0000033408884578871315, -0.0000041983291111243, -0.000005159748013473001, -0.000006228298344069273, -0.000007406506377955272, -0.00000869621880515703, -0.000010098551220537731, -0.000011613838072224862, -0.000013241584365309406, -0.000014980419425581633, -0.00001682805303518602, -0.000018781234258131256, -0.000020835713278459872, -0.000022986206577455574, -0.000025226365778426288, -0.000027548750488237495, -0.00002994480546377966, -0.00003240484242882875, -0.00003491802686220608, -0.000037472370071674534, -0.00004005472685953982, -0.00004265079907538081, -0.00004524514533866021, -0.000047821197199098124, -0.000050361281985599484, -0.00005284665257516863, -0.00005525752429162163, -0.000057573119119994094, -0.00005977171739637624, -0.00006183071710448919, -0.00006372670087970979, -0.00006543551078849601, -0.00006693233091634496, -0.00006819177776061435, -0.00006918799838586096, -0.00006989477625892192, -0.0000702856446389126, -0.00007033400735381076, -0.00007001326675048194, -0.00006929695855908583, -0.00006815889336596997, -0.00006657330434161395, -0.00006451500082217868, -0.00006195952729495476, -0.00005888332728975213, -0.000055263911630295933, -0.00005108003045223614, -0.00004631184834774102, -0.00004094112195109725, -0.00003495137923556008, -0.000028328099749205925, -0.00002105889497699386, -0.000013133687977965725, -0.0000045448914107789386, 0.000004712416972119159, 0.00001464032231114385, 0.00002523790508287317, 0.00003650107899850912, 0.000048422435374760086, 0.00006099109500896964, 0.00007419256860044561, 0.00008800862676544761, 0.00010241718069391788, 0.00011739217449164672, 0.00013290349024195684, 0.0001489168668060355, 0.00016539383336060303, 0.0001822916586456118, 0.00019956331686300406, 0.00021715747113021359, 0.00023501847534903214, 0.00025308639530169407, 0.00027129704973158814, 0.00028958207210598777, 0.0003078689936926356, 0.000326081348511125, 0.0003441388006438945, 0.00036195729431051665, 0.0003794492270230193, 0.000396523646049501, 0.00041308646831854574, 0.00042904072379824936, 0.00044428682228135624, 0.0004587228434024516, 0.00047224484960475214, 0.00048474722166321556, 0.0004961230162578612, 0.0005062643449768824, 0.0005150627740137491, 0.0005224097437066261, 0.0005281970069525315, 0.0005323170854132949, 0.0005346637423161002, 0.000535132470538744, 0.0005336209945592971, 0.0005300297847421818, 0.0005242625823283415, 0.000516226933396756, 0.0005058347299686121, 0.0004930027563345234, 0.0004776532385998766, 0.0004597143953641875, 0.000439120987377791, 0.0004158148639537999, 0.0003897455038555211, 0.00036087054832983304, 0.0003291563239159182, 0.00029457835262655874, 0.00025712184707629384, 0.00021678218811755249, 0.00017356538254255718, 0.0001274884984157665, 0.00007858007561901284, 0.00002688050921948598, -0.00002755759669048593, -0.00008466910698326831, -0.00014437606755626062, -0.00020658745363217785, -0.0002711989563864176, -0.0003380928098956493, -0.0004071376602981107, -0.0004781884789420713, -0.0005510865211747934, -0.0006256593322902957, -0.0007017208020107447, -0.0007790712687237661, -0.0008574976745367521, -0.0009367737720399112, -0.0010166603834929234, -0.0010969057129661245, -0.0011772457117768438, -0.0012574044973655525, -0.0013370948255554808, -0.0014160186159340702, -0.001493867529885975, -0.0015703236005958421, -0.0016450599141258693, -0.0017177413404588983, -0.0017880253131833765, -0.001855562656282923, -0.0019199984562812702, -0.001980972977783946, -0.0020381226202521377, -0.0020910809136427, -0.0021394795503519685, -0.002182949450711119, -0.0022211218590977772, -0.0022536294675537154, -0.0022801075636322415, -0.002300195199042442, -0.0023135363755113357, -0.002319781244150182, -0.0023185873144882605, -0.002309620669227183, -0.0022925571806718527, -0.002267083724711049, -0.002232899388152013, -0.002189716665159731, -0.0021372626385132423, -0.0020752801413688286, -0.0020035288952134924, -0.0019217866197020282, -0.0018298501100975394, -0.0017275362780783611, -0.0016146831517343436, -0.0014911508306520887, -0.0013568223920820803, -0.0012116047442905459, -0.00105542942332504, -0.0008882533295649371, -0.0007100594005859225, -0.0005208572170406406, -0.00032068353844549895, -0.00010960276596572948, 0.00011229267049365711, 0.0003448820033548937, 0.0005880158988156767, 0.0008415163106499223, 0.0011051764180699964, 0.001378760649087365, 0.0016620047905281095, 0.001954616185571629, 0.0022562740193861255, 0.002566629693134372, 0.0028853072863188048, 0.003211904107127226, 0.003545991330130697, 0.0038871147203747305, 0.004234795442594446, 0.004588530953975854, 0.0049477959785794445, 0.005312043561240249, 0.005680706198461858, 0.006053197043531411, 0.006428911182799706, 0.006807226979796384, 0.007187507483585844, 0.007569101897516012, 0.007951347104270668, 0.00833356924290757, 0.00871508533335002, 0.009095204943599961, 0.009473231894756752, 0.009848465998758478, 0.010220204823612604, 0.010587745480750805, 0.01095038642902933, 0.011307429289802029, 0.011658180667418505, 0.012001953969445207, 0.012338071220872989, 0.01266586486656085, 0.012984679556172612, 0.01329387390589094, 0.013592822231241706, 0.013880916245430804, 0.014157566717685371, 0.014422205086201074, 0.014674285020427237, 0.014913283927570648, 0.015138704398367342, 0.015350075587358278, 0.015546954523109315, 0.01572892734403724, 0.01589561045574148, 0.016046651605993875, 0.016181730873806806, 0.016300561569280326, 0.016402891041222927, 0.016488501389844767, 0.016557210082137213, 0.016608870467876506, 0.01664337219452087, 0.016660641519608672, 0.016660641519608672, 0.01664337219452087, 0.01660887046787651, 0.016557210082137213, 0.016488501389844767, 0.016402891041222927, 0.016300561569280326, 0.01618173087380681, 0.016046651605993875, 0.01589561045574148, 0.015728927344037243, 0.015546954523109315, 0.015350075587358278, 0.015138704398367344, 0.014913283927570648, 0.014674285020427237, 0.014422205086201074, 0.014157566717685373, 0.013880916245430808, 0.013592822231241706, 0.013293873905890943, 0.012984679556172612, 0.012665864866560851, 0.01233807122087299, 0.01200195396944521, 0.011658180667418507, 0.01130742928980203, 0.010950386429029334, 0.010587745480750806, 0.010220204823612605, 0.009848465998758478, 0.009473231894756755, 0.009095204943599965, 0.008715085333350022, 0.008333569242907572, 0.00795134710427067, 0.007569101897516013, 0.007187507483585845, 0.006807226979796385, 0.006428911182799707, 0.006053197043531411, 0.00568070619846186, 0.005312043561240251, 0.004947795978579445, 0.004588530953975856, 0.004234795442594447, 0.0038871147203747318, 0.0035459913301306985, 0.003211904107127226, 0.0028853072863188056, 0.002566629693134372, 0.0022562740193861263, 0.00195461618557163, 0.0016620047905281101, 0.0013787606490873656, 0.0011051764180699968, 0.0008415163106499226, 0.0005880158988156769, 0.0003448820033548937, 0.00011229267049365715, -0.00010960276596572952, -0.00032068353844549906, -0.0005208572170406408, -0.0007100594005859228, -0.0008882533295649375, -0.0010554294233250405, -0.0012116047442905463, -0.0013568223920820811, -0.0014911508306520893, -0.0016146831517343445, -0.001727536278078362, -0.0018298501100975405, -0.001921786619702029, -0.0020035288952134933, -0.00207528014136883, -0.0021372626385132423, -0.0021897166651597324, -0.0022328993881520144, -0.00226708372471105, -0.0022925571806718544, -0.0023096206692271846, -0.0023185873144882622, -0.002319781244150184, -0.0023135363755113366, -0.0023001951990424432, -0.0022801075636322433, -0.002253629467553717, -0.002221121859097779, -0.0021829494507111203, -0.00213947955035197, -0.0020910809136427005, -0.002038122620252139, -0.001980972977783947, -0.0019199984562812717, -0.0018555626562829241, -0.0017880253131833778, -0.0017177413404588996, -0.0016450599141258702, -0.0015703236005958424, -0.001493867529885976, -0.0014160186159340711, -0.0013370948255554819, -0.0012574044973655536, -0.0011772457117768447, -0.0010969057129661256, -0.0010166603834929242, -0.0009367737720399119, -0.0008574976745367528, -0.0007790712687237665, -0.0007017208020107451, -0.0006256593322902965, -0.0005510865211747939, -0.0004781884789420716, -0.00040713766029811096, -0.00033809280989564953, -0.0002711989563864178, -0.00020658745363217806, -0.00014437606755626073, -0.00008466910698326835, -0.00002755759669048595, 0.000026880509219485992, 0.0000785800756190129, 0.0001274884984157666, 0.0001735653825425573, 0.00021678218811755262, 0.00025712184707629406, 0.000294578352626559, 0.0003291563239159186, 0.0003608705483298333, 0.00038974550385552137, 0.0004158148639538002, 0.00043912098737779144, 0.000459714395364188, 0.00047765323859987686, 0.0004930027563345237, 0.0005058347299686126, 0.0005162269333967566, 0.0005242625823283428, 0.0005300297847421822, 0.0005336209945592975, 0.0005351324705387445, 0.0005346637423161006, 0.0005323170854132955, 0.0005281970069525319, 0.0005224097437066265, 0.0005150627740137494, 0.0005062643449768828, 0.0004961230162578618, 0.00048474722166321675, 0.00047224484960475257, 0.00045872284340245205, 0.0004442868222813566, 0.00042904072379824974, 0.00041308646831854617, 0.00039652364604950136, 0.0003794492270230197, 0.000361957294310517, 0.00034413880064389544, 0.0003260813485111253, 0.00030786899369263587, 0.00028958207210598804, 0.00027129704973158836, 0.00025308639530169434, 0.00023501847534903239, 0.00021715747113021378, 0.0001995633168630042, 0.000182291658645612, 0.0001653938333606032, 0.0001489168668060359, 0.00013290349024195697, 0.00011739217449164687, 0.00010241718069391802, 0.00008800862676544769, 0.00007419256860044566, 0.000060991095008969726, 0.000048422435374760154, 0.000036501078998509145, 0.000025237905082873258, 0.000014640322311143863, 0.000004712416972119173, -0.000004544891410778945, -0.000013133687977965739, -0.000021058894976993886, -0.000028328099749205973, -0.000034951379235560135, -0.00004094112195109728, -0.00004631184834774111, -0.00005108003045223618, -0.00005526391163029615, -0.00005888332728975221, -0.00006195952729495498, -0.00006451500082217877, -0.00006657330434161406, -0.00006815889336597009, -0.00006929695855908593, -0.000070013266750482, -0.00007033400735381087, -0.00007028564463891286, -0.000069894776258922, -0.00006918799838586128, -0.00006819177776061443, -0.00006693233091634523, -0.0000654355107884961, -0.00006372670087970987, -0.00006183071710448919, -0.00005977171739637624, -0.00005757311911999418, -0.00005525752429162164, -0.00005284665257516885, -0.00005036128198559949, -0.000047821197199098354, -0.00004524514533866022, -0.000042650799075381046, -0.0000400547268595399, -0.00003747237007167462, -0.0000349180268622061, -0.00003240484242882885, -0.000029944805463779895, -0.000027548750488237512, -0.000025226365778426447, -0.000022986206577455652, -0.000020835713278460015, -0.000018781234258131334, -0.00001682805303518612, -0.000014980419425581655, -0.000013241584365309413, -0.000011613838072224883, -0.000010098551220537755, -0.000008696218805157067, -0.0000074065063779552515, -0.000006228298344069309, -0.000005159748013473018, -0.000004198329111124336, -0.000003340888457887144, -0.000002583699544049804, -0.0000019225167274827093, -0.0000013526297992035344, -0.0000008689186702325289, -0.00000046590794503002666, -0.00000013782115841554493, 0.00000012136553541562338, 0.00000031787042142031894, 0.00000045805421772964106, 0.0000005483691815429067, 0.0000005953094918808488, 0.0000006053630630327826, 0.0000005849649316631035, 0.0000005404523499988512, 0.000000478021707330969, 0.0000004036873922555991, 0.00000032324269867252253, 0.0000002422228695576846, 0.0000001658703639385044, 0.00000009910242432011503, 0.00000004648101402982556, 0.000000012185186549259826, -0.000000000014058133132289859};

#define K90SIZE 385
float kern_sinc_90[K90SIZE] = {-0.00000000001835435330954914, 0.00000002787390514473587, 0.00000010379136106565393, 0.00000021479970441785173, 0.0000003463477400875025, 0.0000004824258596266448, 0.0000006057425079743619, 0.0000006979179740632872, 0.0000007396947347929719, 0.0000007111634744153255, 0.0000005920037867268496, 0.0000003617384455521864, -0.000000000000000000003046525547645055, -0.0000005131916847339565, -0.000001197142462019774, -0.0000020701891818909513, -0.0000031493990316601104, -0.0000044502649119623995, -0.000005986398976147703, -0.000007769226615326476, -0.000009807683323123882, -0.000012107917021111969, -0.00001467299856560713, -0.000017502643286524675, -0.000020592946526653855, -0.00002393613625234436, -0.000027520345891421937, -0.000031329410618403446, -0.000035342690348021907, -0.000039534922713009546, -0.00004387610928845733, -0.000048331438280445155, -0.00005286124681877889, -0.00005742102588057646, -0.00006196147072138705, -0.00006642857950207116, -0.00007076380257174866, -0.00007490424459903678, -0.00007878292143526811, -0.00008232907324455845, -0.00008546853504710367, -0.00008812416539503163, -0.00009021633343611528, -0.00009166346412177719, -0.00009238264078470417, -0.00009229026375115919, -0.00009130276306737574, -0.00008933736281233507, -0.00008631289384537109, -0.00008215065120142619, -0.00007677529170483853, -0.00007011576673009798, -0.0000621062844011745, -0.000052687294896268665, -0.00004180649191875067, -0.000029419822814530276, -0.000015492499267993766, 0.00000000000000000008567663183732722, 0.00001707094357087302, 0.00003572138815170654, 0.000055939255680279074, 0.00007769845679165306, 0.00010095807093656725, 0.00012566159357414296, 0.0001517362609101831, 0.00017909246261304, 0.00020762325280740718, 0.00023720396941913105, 0.0002676919716184486, 0.0002989265046830244, 0.00033072870107474976, 0.00036290172589516624, 0.0003952310741544142, 0.000427485026459302, 0.0004594152688001889, 0.0004907576810973401, 0.000521233298059933, 0.0005505494447204314, 0.0005784010477401538, 0.0006044721222459802, 0.0006284374325615939, 0.0006499643237486884, 0.0006687147193841262, 0.0006843472794789562, 0.0006965197109058085, 0.000704891221154605, 0.0007091251046951778, 0.0007088914497023129, 0.0007038699514071039, 0.0006937528168918143, 0.0006782477447572336, 0.0006570809617753387, 0.0006300002974092707, 0.0005967782759504287, 0.0005572152050015241, 0.0005111422381370815, 0.00045842438881067287, 0.0003989634719620521, 0.000332700949317393, 0.00025962065408099836, 0.00017975137059528826, 0.00009316924460429864, -0.0000000000000000003382337837868463, -0.00009957906163531658, -0.00020533730175068633, -0.0003169892480515526, -0.0004341933814530433, -0.0005565512267794142, -0.0006836067658319123, -0.0008148461898676993, -0.0009496980067753144, -0.0010875335163057116, -0.0012276676646317218, -0.0013693602872740908, -0.0015118177470616844, -0.0016541949713010276, -0.0017955978897314798, -0.001935086272153528, -0.002071676961856729, -0.002204347498159272, -0.0023320401185227164, -0.0024536661278433004, -0.0025681106196663406, -0.002674237531243855, -0.002770895011579273, -0.002856921078898634, -0.002931149541376599, -0.0029924161524493014, -0.003039564969685583, -0.003071454883983633, -0.0030869662838315277, -0.003085007817535802, -0.003064523214700038, -0.003024498126841667, -0.0029639669458846113, -0.0028820195583717637, -0.0027778079926159714, -0.0026505529156614005, -0.0024995499368668504, -0.002324175675154702, -0.00212389354749797, -0.0018982592370449065, -0.001646925800405725, -0.0013696483750464958, -0.001066288449446492, -0.0007368176606700757, -0.0003813210862735905, 0.0000000000000000006913857394227992, 0.00040682593650394523, 0.0008387170706972385, 0.0012951127663974869, 0.0017753310393637247, 0.00227856883568966, 0.0028039029637277847, 0.003350291686375126, 0.003916576976557293, 0.004501487434675075, 0.005103641862654802, 0.005721553485097331, 0.006353634803879909, 0.006998203068458377, 0.007653486340073646, 0.00831763012411403, 0.008988704541052677, 0.009664712002694508, 0.010343595356956396, 0.011023246461094278, 0.011701515140205513, 0.012376218484997984, 0.013045150440250456, 0.013706091633111903, 0.014356819388418617, 0.014995117876563184, 0.01561878833814249, 0.016225659328654347, 0.016813596925913048, 0.01738051484262003, 0.017924384386660518, 0.018443244212202056, 0.01893520980554517, 0.01939848265091586, 0.01983135902298802, 0.02023223835487181, 0.02059963113259058, 0.020932166269679045, 0.021228597918453822, 0.021487811677714776, 0.021708830160111423, 0.021890817886130235, 0.0220330854756016, 0.022135093111763135, 0.02219645325722192, 0.022216932605602566, 0.02219645325722192, 0.022135093111763135, 0.0220330854756016, 0.021890817886130235, 0.021708830160111423, 0.02148781167771478, 0.021228597918453822, 0.020932166269679045, 0.020599631132590585, 0.02023223835487181, 0.019831359022988024, 0.01939848265091586, 0.01893520980554517, 0.018443244212202056, 0.017924384386660518, 0.017380514842620032, 0.016813596925913048, 0.01622565932865435, 0.015618788338142491, 0.014995117876563185, 0.01435681938841862, 0.013706091633111908, 0.013045150440250456, 0.012376218484997986, 0.011701515140205516, 0.01102324646109428, 0.010343595356956397, 0.00966471200269451, 0.008988704541052678, 0.00831763012411403, 0.007653486340073649, 0.0069982030684583784, 0.00635363480387991, 0.005721553485097333, 0.005103641862654804, 0.0045014874346750765, 0.003916576976557295, 0.003350291686375127, 0.0028039029637277847, 0.0022785688356896606, 0.0017753310393637256, 0.0012951127663974875, 0.0008387170706972388, 0.0004068259365039454, 0.0000000000000000006913857394227994, -0.00038132108627359065, -0.0007368176606700761, -0.0010662884494464925, -0.001369648375046496, -0.001646925800405725, -0.0018982592370449076, -0.0021238935474979714, -0.002324175675154703, -0.0024995499368668517, -0.0026505529156614026, -0.002777807992615972, -0.0028820195583717663, -0.002963966945884614, -0.0030244981268416683, -0.0030645232147000386, -0.003085007817535803, -0.0030869662838315308, -0.0030714548839836336, -0.003039564969685585, -0.002992416152449305, -0.0029311495413765994, -0.0028569210788986364, -0.002770895011579276, -0.002674237531243857, -0.0025681106196663406, -0.0024536661278433012, -0.0023320401185227186, -0.0022043474981592722, -0.0020716769618567303, -0.0019350862721535297, -0.0017955978897314802, -0.0016541949713010289, -0.0015118177470616868, -0.0013693602872740917, -0.0012276676646317218, -0.0010875335163057118, -0.0009496980067753149, -0.0008148461898676995, -0.0006836067658319129, -0.0005565512267794149, -0.0004341933814530434, -0.0003169892480515529, -0.00020533730175068657, -0.00009957906163531667, -0.0000000000000000003382337837868467, 0.00009316924460429868, 0.00017975137059528842, 0.00025962065408099836, 0.0003327009493173933, 0.00039896347196205256, 0.0004584243888106731, 0.000511142238137082, 0.0005572152050015249, 0.0005967782759504293, 0.0006300002974092716, 0.0006570809617753398, 0.0006782477447572344, 0.0006937528168918143, 0.0007038699514071047, 0.0007088914497023139, 0.0007091251046951779, 0.0007048912211546057, 0.0006965197109058096, 0.0006843472794789566, 0.0006687147193841273, 0.0006499643237486897, 0.0006284374325615946, 0.0006044721222459802, 0.0005784010477401544, 0.0005505494447204321, 0.0005212332980599331, 0.0004907576810973407, 0.00045941526880018975, 0.00042748502645930243, 0.0003952310741544148, 0.0003629017258951671, 0.0003307287010747502, 0.0002989265046830244, 0.00026769197161844875, 0.00023720396941913143, 0.00020762325280740727, 0.0001790924626130403, 0.0001517362609101834, 0.00012566159357414296, 0.00010095807093656743, 0.00007769845679165322, 0.000055939255680279175, 0.00003572138815170663, 0.000017070943570873068, 0.00000000000000000008567663183732738, -0.000015492499267993803, -0.000029419822814530304, -0.00004180649191875076, -0.000052687294896268706, -0.00006210628440117445, -0.00007011576673009818, -0.00007677529170483862, -0.0000821506512014264, -0.0000863128938453712, -0.00008933736281233527, -0.0000913027630673758, -0.00009229026375115956, -0.0000923826407847044, -0.00009166346412177756, -0.00009021633343611542, -0.0000881241653950317, -0.00008546853504710386, -0.00008232907324455837, -0.00007878292143526844, -0.00007490424459903695, -0.00007076380257174883, -0.00006642857950207124, -0.00006196147072138719, -0.00005742102588057649, -0.000052861246818779256, -0.00004833143828044534, -0.00004387610928845742, -0.00003953492271300968, -0.000035342690348021974, -0.0000313294106184035, -0.000027520345891421947, -0.00002393613625234455, -0.000020592946526653905, -0.000017502643286524814, -0.000014672998565607187, -0.000012107917021111969, -0.000009807683323123895, -0.0000077692266153265, -0.000005986398976147723, -0.000004450264911962408, -0.000003149399031660131, -0.000002070189181890941, -0.0000011971424620197774, -0.0000005131916847339617, -0.0000000000000000000030465255476450786, 0.0000003617384455521864, 0.0000005920037867268463, 0.0000007111634744153355, 0.0000007396947347929653, 0.000000697917974063279, 0.0000006057425079743619, 0.0000004824258596266671, 0.00000034634774008749007, 0.0000002147997044178792, 0.00000010379136106565393, 0.00000002787390514473587, -0.00000000001835435330954914};

#define KSIZE 257
float kern_sinc_60[KSIZE] = {-0.000000000027531529967774173, 0.00000009089737599212115, 0.0000003221995566671586, 0.0000006223101062362994, 0.0000009086137620754153, 0.000001089507000233215, 0.0000010667452117566824, 0.0000007380570959565597, -0.00000000000000000000456978832204031, -0.000001248974885636361, -0.0000031052837732256365, -0.00000565683980219572, -0.00000897959846534696, -0.000013134072477980545, -0.000018161875533944167, -0.000024082360107867446, -0.000030889419793852175, -0.00003854853140176266, -0.00004699411593349488, -0.00005612730039627325, -0.00006581416394093443, -0.00007588455181032807, -0.00008613153883165953, -0.00009631162049529225, -0.00010614570387092615, -0.00011532096259871584, -0.000123493609882315, -0.00013029263077978057, -0.00013532450017113293, -0.00013817889567422912, -0.0001384353956440888, -0.00013567113145128694, -0.0001294693407842829, -0.00011942874511370695, -0.00010517365010832796, -0.00008636464317123126, -0.0000627097378859854, -0.00003397579157935215, 0.00000000000000000012851494777209752, 0.000039298747121809015, 0.00008390888353093559, 0.00013371580531900301, 0.00018849239038483807, 0.0002478906641817225, 0.00031143487925014266, 0.00037851627270691257, 0.00044838975708073365, 0.0005201727854183854, 0.0005928466113059223, 0.0006652601383389893, 0.0007361365217382699, 0.0008040826474668411, 0.000867601571718967, 0.0009251079564938157, 0.0009749464857452219, 0.0010154131920298152, 0.001044779566489654, 0.0010613192663287592, 0.0010633371746867363, 0.0010492005090562253, 0.0010173716172633559, 0.0009664420456907039, 0.000895167414037834, 0.000802502585638582, 0.0006876365833021889, 0.0005500266688719463, 0.000389430981170303, 0.00020593911258679355, -0.0000000000000000005073506757438554, -0.00022755348840526016, -0.0004754838721369209, -0.0007421328570948623, -0.0010254101488763846, -0.0013227877656158144, -0.0016313002746630172, -0.0019475513067003082, -0.002267726620876739, -0.0025876139061673316, -0.0029026294085940777, -0.0032078513724997128, -0.003498060178222484, -0.003767784949891711, -0.004011356297368523, -0.00422296474739287, -0.004396724312615935, -0.004526740545264397, -0.004607182326552863, -0.004632356555439018, -0.004596784822626168, -0.004495281089469607, -0.004323029338099447, -0.004075660119920244, -0.0037493249057701755, -0.0033407671332752967, -0.0028473888559242193, -0.0022673119244567166, -0.0015994326743701904, -0.0008434691534786232, 0.0000000000000000010370786092641748, 0.0009295058261948526, 0.001942669149839708, 0.003036191094801014, 0.004205854446118793, 0.005446536157472904, 0.006752231152858867, 0.008116087416506802, 0.009530452207014312, 0.01098692907269529, 0.012476445187734705, 0.013989328375363236, 0.015515393037379132, 0.0170440340713321, 0.018564327729823627, 0.020065138262796604, 0.021535229085326922, 0.02296337713201079, 0.024338488996031846, 0.025649717407579552, 0.02688657658336045, 0.02803905497706121, 0.029097723980020584, 0.03005384116193944, 0.030899446702758477, 0.03162745174808122, 0.03223171752061173, 0.032707124137599575, 0.03304962821754448, 0.0332563085064532, 0.033325398912580496, 0.0332563085064532, 0.03304962821754448, 0.032707124137599575, 0.032231717520611734, 0.03162745174808122, 0.030899446702758477, 0.030053841161939442, 0.029097723980020584, 0.02803905497706121, 0.02688657658336045, 0.025649717407579552, 0.024338488996031846, 0.022963377132010795, 0.021535229085326922, 0.020065138262796604, 0.01856432772982363, 0.0170440340713321, 0.015515393037379133, 0.013989328375363236, 0.012476445187734705, 0.010986929072695294, 0.009530452207014314, 0.008116087416506802, 0.006752231152858867, 0.0054465361574729055, 0.004205854446118793, 0.003036191094801014, 0.0019426691498397085, 0.0009295058261948527, 0.0000000000000000010370786092641752, -0.0008434691534786234, -0.0015994326743701906, -0.0022673119244567166, -0.0028473888559242197, -0.003340767133275298, -0.003749324905770178, -0.004075660119920246, -0.004323029338099447, -0.0044952810894696065, -0.004596784822626169, -0.00463235655543902, -0.004607182326552864, -0.004526740545264398, -0.004396724312615936, -0.00422296474739287, -0.0040113562973685245, -0.003767784949891713, -0.0034980601782224866, -0.003207851372499712, -0.0029026294085940777, -0.0025876139061673316, -0.00226772662087674, -0.0019475513067003082, -0.0016313002746630176, -0.001322787765615815, -0.0010254101488763852, -0.0007421328570948627, -0.00047548387213692134, -0.00022755348840526013, -0.0000000000000000005073506757438552, 0.00020593911258679355, 0.000389430981170303, 0.0005500266688719464, 0.0006876365833021893, 0.0008025025856385822, 0.0008951674140378345, 0.0009664420456907047, 0.001017371617263357, 0.0010492005090562261, 0.0010633371746867361, 0.0010613192663287594, 0.001044779566489654, 0.0010154131920298152, 0.0009749464857452222, 0.0009251079564938162, 0.0008676015717189675, 0.0008040826474668418, 0.0007361365217382705, 0.0006652601383389903, 0.0005928466113059221, 0.0005201727854183852, 0.00044838975708073365, 0.00037851627270691257, 0.00031143487925014277, 0.00024789066418172265, 0.00018849239038483807, 0.00013371580531900312, 0.0000839088835309357, 0.00003929874712180907, 0.00000000000000000012851494777209776, -0.000033975791579352114, -0.00006270973788598536, -0.00008636464317123126, -0.00010517365010832795, -0.00011942874511370703, -0.00012946934078428307, -0.0001356711314512872, -0.00013843539564408887, -0.0001381788956742294, -0.00013532450017113314, -0.00013029263077978093, -0.00012349360988231492, -0.00011532096259871588, -0.00010614570387092614, -0.00009631162049529236, -0.00008613153883165957, -0.00007588455181032816, -0.00006581416394093458, -0.00005612730039627338, -0.000046994115933495, -0.000038548531401762774, -0.00003088941979385225, -0.000024082360107867473, -0.000018161875533944167, -0.000013134072477980545, -0.000008979598465346944, -0.000005656839802195709, -0.000003105283773225621, -0.0000012489748856363687, -0.000000000000000000004569788322040346, 0.0000007380570959565635, 0.0000010667452117566976, 0.000001089507000233215, 0.0000009086137620754153, 0.0000006223101062362994, 0.00000032219955666713796, 0.00000009089737599212115, -0.000000000027531529967774173};

#define KCSIZE 65
float kern_i[KCSIZE*2], kern_q[KCSIZE*2];
float kern_iq_base[KCSIZE] = {-0.00000000014096265261536194, 0.0000052532194745394466, -0.00000000000000000002742383532207126, -0.00005191623052677217, -0.00015815519722251332, -0.00026330567436730454, -0.00025098490783428176, 0.00000000000000000038279610120778856, 0.0005179737923236473, 0.0011476335886173657, 0.001535593296507842, 0.001245971474712538, -0.0000000000000000013416010915106481, -0.0020514716335533895, -0.004179896421181109, -0.0052089877327154465, -0.003975623132273221, 0.00000000000000000304467086911566, 0.0059284866555000485, 0.01161086072076, 0.013994846079498914, 0.010396195099111442, -0.000000000000000005201220195802481, -0.01500009213247678, -0.0292707755082093, -0.03555225142194426, -0.027013953695180584, 0.000000000000000007058492096786339, 0.043895945990814735, 0.09737208336996771, 0.14898163531392486, 0.1863501228402897, 0.19998962477388874, 0.1863501228402897, 0.14898163531392486, 0.09737208336996771, 0.043895945990814735, 0.000000000000000007058492096786339, -0.027013953695180584, -0.03555225142194427, -0.029270775508209303, -0.01500009213247679, -0.000000000000000005201220195802482, 0.010396195099111443, 0.013994846079498925, 0.011610860720760004, 0.005928486655500052, 0.0000000000000000030446708691156587, -0.003975623132273223, -0.0052089877327154525, -0.004179896421181109, -0.0020514716335533903, -0.0000000000000000013416010915106475, 0.0012459714747125386, 0.0015355932965078441, 0.0011476335886173653, 0.0005179737923236479, 0.0000000000000000003827961012077892, -0.0002509849078342817, -0.0002633056743673052, -0.0001581551972225137, -0.000051916230526772085, -0.000000000000000000027423835322071474, 0.0000052532194745394466, -0.00000000014096265261536194};

void ntsc_emitter (unsigned y, byte *colors, byte *emphasis)
{
    Uint32 *dest0 = (Uint32 *) (((byte *)window_surface->pixels) + (y*2) * window_surface->pitch);
    Uint32 *line0 = dest0;
    Uint32 *line1 = (Uint32 *) (((byte *)window_surface->pixels) + (y*2+1) * window_surface->pitch);
    float chroma_polarity = ((nes.time ^ y) & 1)? -1.0 : 1.0; 

    float rbuf[(256*8 + 2*0)*5+1025];
    float ybuf[(256*8 + 2*0)*5+1025];
    float ibuf[(256*8 + 2*0)*5+1025];
    float qbuf[(256*8 + 2*0)*5+1025];
    const int pad = 0;

    // Generate video signal:
    memset(rbuf, 0, sizeof(rbuf));
    memset(ybuf, 0, sizeof(ybuf));
    memset(ibuf, 0, sizeof(ibuf));
    memset(qbuf, 0, sizeof(qbuf));

    int step = 0;
    int stepmod = 0;
    for (int x=0; x < 256; x++) {
        byte col = colors[x] & 63;

        for (int i=0; i<8; i++) {
            float level = yiq_table[col][0] + chroma_polarity * chroma_output[col][stepmod];
            int base = (step+pad)*5;
            rbuf[base+0] = level * 5.0;
//            rbuf[base+1] = level;
//            rbuf[base+2] = level;
//            rbuf[base+3] = level;
//            rbuf[base+4] = level;
            step++;
            stepmod++;
            if (stepmod == 12) stepmod = 0;
        }
    }

    // Lowpass filter
    for (int i=0; i < sizeof(ibuf)/sizeof(ibuf[0]); i++) {
        float si = rbuf[i] * kern_i[i%60] * chroma_polarity;
        float sq = rbuf[i] * kern_q[i%60] * chroma_polarity;

        for (int j=0; j<K120SIZE; j++) {
            ibuf[i+j] += si * kern_sinc_120[j];
            qbuf[i+j] += sq * kern_sinc_120[j];
        }
        
        for (int j=0; j<K90SIZE; j++) {
            ybuf[i+j] += rbuf[i] * kern_sinc_90[j];
        }
    }

    // Filter to YIQ and produce pixels:
    for (int x=0; x<640; x++) {
        float rgb[3];
        float yiq[3] = { 0.0f, 0.0f, 0.0f };
        int cidx = 8 + pad*5 + x*16;
        int ioffset = (-KSIZE/2) + cidx;
        int coffset = (-KCSIZE/2) + cidx;
        int croff = coffset % 60;

        //for (int i=0; i<KSIZE; i++) yiq[0] += kern_sinc_60[i] * rbuf[ioffset+i];        
//        yiq[0] /= (float)KSIZE;
//        yiq[0] *= 5.0 / 12.0;

        float scale = 12.0 * 0.5;
        yiq[0] = ybuf[cidx + K90SIZE/2] * scale / 12.0;
//        yiq[0] *= 5.0 / 12.0;
        yiq[1] = ibuf[cidx + K120SIZE/2] * scale * 1.5;
        yiq[2] = qbuf[cidx + K120SIZE/2] * scale * 1.5;

        yiq[1] *= yiq[0] * 1.3;
        yiq[2] *= yiq[0] * 1.3;


        /*for (int i=0; i<KCSIZE; i++) {
            float signal = rbuf[coffset+i];
            float lowpass = 5.00 * kern_iq_base[i];
            yiq[1] += lowpass*kern_i[croff+i] * signal;
            yiq[2] += lowpass*kern_q[croff+i] * signal;
        }*/

        //yiq[1] *= 5.0;
        //yiq[2] *= 5.0;

        
        /* for (int i=0; i<60; i+=5) {
            float scale = 60.0;
            yiq[0] += rbuf[cidx + i] * (scale/60.0) / 12.0;
            yiq[1] += rbuf[cidx + i] * (scale/60.0) * kern_i12[((cidx + i)/5)%12];
            yiq[2] += rbuf[cidx + i] * (scale/60.0) * kern_q12[((cidx + i)/5)%12];
        }*/

/*
        for (int i=0; i<60; i++) {
            float scale = 60.0 * 5.0;
            yiq[0] += rbuf[cidx + i] * (scale/60.0) / 12.0;
            yiq[1] += rbuf[cidx + i] * (scale/60.0) * kern_i12[cidx+i];
            yiq[2] += rbuf[cidx + i] * (scale/60.0) * kern_q12[cidx+i];
        }
*/
        yiq2rgb(yiq, rgb);
        Uint32 ox = dest0[0];
        byte r = ox >> 16, g = (ox >> 8) & 0xFF, b = ox & 0xFF;
        *dest0++ = rgbf(rgb[0] + r/512.0, rgb[1] + g/512.0, rgb[2] + b/512.0);
    }

/*    
    for (int x = 0; x < 256; x++) {
        byte col = colors[x] & 63;
        Uint32 px;
        float rgb[3];
        float yiq[3] = { 0.0f, 0.0f, 0.0f };

        yiq[0] = yiq_table[col][0];
        for (int i=0; i<12; i++) {
            yiq[1] += kern_i12[i] * chroma_output[col][i];
            yiq[2] += kern_q12[i] * chroma_output[col][i];
        }

        yiq2rgb(yiq, rgb);
        px = rgbf(rgb[0], rgb[1], rgb[2]);
        

        *dest0++ = px; 

    }
*/
    for (int x=0; x<640; x++) {
        
        Uint32 nx = line0[x];
        byte r = nx >> 16, g = (nx >> 8) & 0xFF, b = nx & 0xFF;
        r = r*2/4; 
        g = g*2/4; 
        b = b*2/4;
        nx = rgbi(r, g, b);  
        line1[x] = nx;
    }
}

void yiq_test_emitter (unsigned y, byte *colors, byte *emphasis);

void ntsc_filter (void)
{
    double twelfth = 2.0 * M_PI / 12.0;
    double tint = 0.2;
    double tint_radians = tint * twelfth;
    memset(chroma_output, 0, sizeof(chroma_output));

    // Base YIQ sinusoid for testing
    for (int step=0; step<12; step++) {
        double phase = ((double)step) * twelfth + tint_radians;
        kern_i12[step] = -cos(phase);
        kern_q12[step] = sin(phase);
    }

    // Build I/Q decoder kernels
    for (int i=0; i<2*KCSIZE; i++) {
        double phase = ((double)i) * 2.0 * M_PI / 60.0;
        kern_i[i] = -cos(phase);
        kern_q[i] =  sin(phase);        
    }

    float epsilonf = 0.0000000000000001;
    // Scrub out denormalized floats:
    /*
    for (int i=0; i<KSIZE; i++) {
        if (fabs(kern_sinc_60[i]) < epsilonf) kern_sinc_60[i] = 0.0;
    }

    for (int i=0; i<K90SIZE; i++)
        if (fabs(kern_sinc_90[i]) < epsilonf) kern_sinc_90[i] = 0.0;

    for (int i=0; i<K120SIZE; i++)
        if (fabs(kern_sinc_120[i]) < epsilonf) kern_sinc_120[i] = 0.0;

    for (int i=0; i<KCSIZE; i++) {
        if (fabs(kern_iq_base[i]) < epsilonf) kern_iq_base[i] = 0.0;
    }

    for (int i=0; i<KCSIZE*2; i++) {
        if (fabs(kern_i[i]) < epsilonf) kern_i[i] = 0.0;
        if (fabs(kern_q[i]) < epsilonf) kern_q[i] = 0.0;
    }
    */


    // Generate a YIQ palette 
    for (int col=0; col<64; col++) {
        float *yiq = &yiq_table[col][0];
        int x = col & 15;        
        //double saturations[4] = { 0.260, 0.460, 0.400, 0.260 };
        //double intensities[4] = { 0.15, 0.6, 1.0, 1.2 };
        double saturations[4] = { 0.9, 0.65, 0.42, 0.26 };
        double saturation = saturations[col>>4];
        double intensities[4] = { 1.0, 1.0, 1.0, 1.2 };


        yiq[0] = 0.0;
        yiq[1] = 0.0;
        yiq[2] = 0.0;
        
        if (x < 0xE) {
            yiq[0] = (1.0-saturation) * intensities[col >> 4];            

            if (x == 0) {
                yiq[0] += 0.25 * (1.0 - saturation);
            } else if (x == 0x0D) {
                yiq[0] -= intensities[0] * (1.0 - saturation);
            } else if (x < 0xD) {
                double phase = ((double)(x-1) + tint) * 2.0 * M_PI / 12.0;
                yiq[1] = saturation * -cos(phase);
                yiq[2] = saturation * sin(phase);
                chroma_output[col][x-1] += saturation;
            }

            //for (int i=0; i<12; i++) chroma_output[col][i] += yiq[0];
        }
    }
    vid_width = 640;
    vid_height = 480;
    vid_bpp = 32;
    filter_output_line = ntsc_emitter;
}



void yiq_test_emitter (unsigned y, byte *colors, byte *emphasis)
{
    Uint32 *dest0 = (Uint32 *) (((byte *)window_surface->pixels) + (y*2) * window_surface->pitch);
    Uint32 *dest1 = (Uint32 *) (((byte *)window_surface->pixels) + (y*2+1) * window_surface->pitch);
    
    for (int x = 0; x < 256; x++) {
        byte col = colors[x];
        Uint32 px;
        float rgb[3];
        //float yiq[3] = { 0.250*(col>>4), 0.0, 0.0 };

        yiq2rgb(yiq_table[col&63], rgb);
        px = rgbf(rgb[0], rgb[1], rgb[2]);
        

        *dest0++ = px; 
        *dest0++ = px;

        Uint32 nx = px;
        byte r = nx >> 16, g = (nx >> 8) & 0xFF, b = nx & 0xFF;
        r = r*2/4; 
        g = g*2/4; 
        b = b*2/4;
        nx = rgbi(r, g, b);

        dest1[1] = dest1[0] = nx;
        dest1 += 2;

    }
}
